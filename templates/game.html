{% extends "base.html" %}

{% block title %}Partie en cours - C'est Trop Dur{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/game.css') }}">
{% endblock %}

{% block body %}
<div class="game-layout">
  <!-- ==================== HEADER ==================== -->
  <header class="game-header">
    <div class="header-left">
      <div class="round-badge">
        <span class="round-label">Tour</span>
        <span class="round-value" id="roundInfo">1/1</span>
      </div>
      <div class="phase-info" id="phaseInfo">En attente...</div>
    </div>

    <div class="header-center">
      <div class="timer-container" id="timerContainer">
        <svg class="timer-svg" viewBox="0 0 100 100">
          <circle class="timer-bg" cx="50" cy="50" r="45"
                  fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="6"/>
          <circle class="timer-progress" id="timerProgress" cx="50" cy="50" r="45"
                  fill="none" stroke="var(--accent-gold)" stroke-width="6"
                  stroke-linecap="round"
                  stroke-dasharray="282.7"
                  stroke-dashoffset="0"
                  transform="rotate(-90 50 50)"/>
        </svg>
        <div class="timer-text" id="timerText">--</div>
      </div>
      <div class="word-display" id="wordDisplay"></div>
    </div>

    <div class="header-right">
      <button class="voice-toggle" id="voiceMiniBtn" onclick="toggleVoice()">
        <svg class="voice-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
        <span class="voice-label" id="voiceLabel">Micro OFF</span>
      </button>
    </div>
  </header>

  <!-- ==================== MAIN CONTENT ==================== -->
  <main class="game-main">
    <!-- SCORE PANEL -->
    <aside class="score-panel glass-card">
      <h3 class="panel-title">Joueurs</h3>
      <div class="players-list" id="scoresPanel"></div>
    </aside>

    <!-- CANVAS PANEL -->
    <section class="canvas-panel">
      <div class="canvas-wrapper">
        <canvas id="drawCanvas" width="800" height="600"></canvas>

        <!-- Overlay: Choosing -->
        <div class="overlay hidden" id="choosingOverlay">
          <div class="overlay-content animate-fade-in">
            <h2 class="overlay-title">Choisissez un mot</h2>
            <div class="card-choices" id="cardChoices"></div>
            <div id="designateSection" class="hidden" style="margin-top: 24px;">
              <h3 class="overlay-subtitle">Designez un joueur pour dessiner</h3>
              <div class="card-choices" id="playerChoices"></div>
            </div>
            <button class="btn btn-primary hidden" id="confirmChoiceBtn" onclick="confirmChoice()">
              Valider le choix
            </button>
          </div>
        </div>

        <!-- Overlay: Waiting for choice -->
        <div class="overlay hidden" id="waitingChooseOverlay">
          <div class="overlay-content animate-fade-in">
            <div class="waiting-spinner"></div>
            <h2 class="overlay-title" id="waitingChooseText">Un joueur choisit un mot...</h2>
          </div>
        </div>

        <!-- Overlay: Round end -->
        <div class="overlay hidden" id="roundEndOverlay">
          <div class="overlay-content animate-fade-in">
            <h2 class="overlay-title">Fin du tour !</h2>
            <p class="overlay-word">Le mot etait : <strong id="revealWord"></strong></p>
            <p class="overlay-result" id="roundResultMsg"></p>
            <button class="btn btn-primary hidden" id="nextTurnBtn" onclick="requestNextTurn()">
              Tour suivant
            </button>
            <p class="overlay-wait hidden" id="waitingNextMsg">En attente de l'hote...</p>
          </div>
        </div>

        <!-- Overlay: Game over -->
        <div class="overlay hidden" id="gameOverOverlay">
          <div class="overlay-content animate-fade-in">
            <h2 class="overlay-title">Partie terminee !</h2>
            <p class="overlay-word">Le mot etait : <strong id="revealWordFinal"></strong></p>
            <div class="podium" id="podium"></div>
            <a href="/" class="btn btn-primary" style="margin-top: 24px;">Retour a l'accueil</a>
          </div>
        </div>
      </div>

      <!-- Drawing Tools -->
      <div class="drawing-tools hidden" id="drawTools">
        <div class="tools-group colors-group">
          <div class="color-btn active" style="background:#1a1a1a" data-color="#000000"></div>
          <div class="color-btn" style="background:#e74c3c" data-color="#e74c3c"></div>
          <div class="color-btn" style="background:#3498db" data-color="#3498db"></div>
          <div class="color-btn" style="background:#2ecc71" data-color="#2ecc71"></div>
          <div class="color-btn" style="background:#f39c12" data-color="#f39c12"></div>
          <div class="color-btn" style="background:#9b59b6" data-color="#9b59b6"></div>
          <div class="color-btn" style="background:#795548" data-color="#795548"></div>
          <div class="color-btn white-color" style="background:#ffffff" data-color="#ffffff"></div>
        </div>
        <div class="tools-divider"></div>
        <div class="tools-group size-group">
          <button class="size-btn active" data-size="3" title="Fin">
            <span class="size-dot size-small"></span>
          </button>
          <button class="size-btn" data-size="8" title="Moyen">
            <span class="size-dot size-medium"></span>
          </button>
          <button class="size-btn" data-size="16" title="Gros">
            <span class="size-dot size-large"></span>
          </button>
        </div>
        <div class="tools-divider"></div>
        <div class="tools-group action-group">
          <button class="tool-btn" id="eraserBtn" title="Gomme">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <path d="M20 20H7L3 16a1 1 0 0 1 0-1.4l9.6-9.6a1 1 0 0 1 1.4 0l7 7a1 1 0 0 1 0 1.4L16 18"/>
              <path d="M6.5 13.5 14.5 5.5"/>
            </svg>
          </button>
          <button class="tool-btn" id="clearBtn" title="Effacer tout">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>
    </section>

    <!-- CHAT PANEL -->
    <aside class="chat-panel glass-card">
      <h3 class="panel-title">Chat</h3>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input-wrapper">
        <input type="text" class="input-field chat-input" id="chatInput"
               placeholder="Tapez votre reponse..." autocomplete="off" maxlength="100">
        <button class="btn btn-primary chat-send" id="chatSend" onclick="sendGuess()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
        </button>
      </div>
    </aside>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
  const roomCode = '{{ room.code }}';
  const myPlayerId = '{{ player_id }}';
  const isHost = {{ 'true' if player_id == room.host_player_id else 'false' }};
</script>
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
{% endblock %}
